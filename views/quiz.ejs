<!DOCTYPE html>
<html lang="fr">
  <head>
    <title>LSF — Quiz</title>
    <%- include('partials/head') %>
  </head>
  <body>
    <%- include('partials/navbar') %>

    <!-- Header -->
    <header class="max-w-5xl mx-auto px-4 py-8">
      <h2 class="text-3xl md:text-4xl font-bold text-[#00a8a3]">Quiz — LSF</h2>
      <p class="mt-1 text-neutral-700 text-sm">
        Testez vos connaissances en LSF
      </p>
    </header>

    <!-- Quiz -->
    <main class="max-w-5xl mx-auto px-4 pb-16">
      <div class="grid md:grid-cols-2 gap-6">
        <% questions.forEach((q, idx)=>{ %>
        <section
          class="rounded-2xl border bg-white p-4 shadow"
          data-qid="<%= q.id %>"
        >
          <header class="mb-3">
            <h2 class="font-semibold text-[#f46b5e]">
              Question <%= idx + 1 %>
            </h2>
          </header>

          <!-- Media -->
          <div class="rounded-xl overflow-hidden border bg-black/5">
            <% if (q.mediaType === "video") { %>
            <video
              class="w-full aspect-video"
              src="<%= q.src %>"
              controls
              preload="metadata"
            ></video>
            <% } else { %>
            <img class="w-full" src="<%= q.src %>" alt="Signe LSF" />
            <% } %>
          </div>

          <!-- Réponse -->
          <div class="mt-4">
            <% if (q.mode === "input") { %>
            <label class="block text-sm text-neutral-700 mb-1"
              >Ta réponse :</label
            >
            <input
              type="text"
              class="ansInput w-full rounded-lg border px-3 py-2"
              placeholder="Écris le mot (ex: bonjour)"
            />
            <% } else { %>
            <fieldset class="grid gap-2">
              <% q.choices.forEach((ch, ci)=>{ %>
              <label
                class="flex items-center gap-2 rounded-lg border px-3 py-2 hover:bg-neutral-50 cursor-pointer"
              >
                <input
                  type="radio"
                  class="ansChoice h-4 w-4"
                  name="q-<%= q.id %>"
                  value="<%= ci %>"
                />
                <span><%= ch %></span>
              </label>
              <% }) %>
            </fieldset>
            <% } %>
          </div>

          <!-- Actions -->
          <div class="mt-4 flex items-center gap-3">
            <button
              class="btnCheck rounded-lg bg-[#00a8a3] px-4 py-2 text-white text-sm font-semibold hover:bg-[#00928e]"
            >
              Vérifier
            </button>
            <button
              class="btnReset rounded-lg border px-3 py-2 text-sm bg-white hover:border-[#00a8a3]"
            >
              Effacer
            </button>
            <span class="ml-auto text-xs text-neutral-500"
              >Indice après correction</span
            >
          </div>

          <!-- Résultat -->
          <p class="mt-3 hidden text-sm font-medium" data-exp></p>

          <!-- Données cachées pour simplifier le JS -->
          <script type="application/json" data-qdata>
            <%- JSON.stringify(q) %>
          </script>
        </section>
        <% }) %>
      </div>

      <!-- Score global -->
      <div
        class="mt-8 rounded-2xl border bg-white p-4 shadow flex items-center justify-between"
      >
        <p class="text-sm">
          Score : <strong id="score">0 / <%= questions.length %></strong>
        </p>
        <button
          id="btnResetAll"
          class="rounded-lg border px-4 py-2 bg-white hover:border-[#00a8a3] text-sm"
        >
          Tout recommencer
        </button>
      </div>
    </main>

    <script>
      // Petit utilitaire
      const norm = (s) =>
        (s || "")
          .toString()
          .trim()
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, ""); // supprime accents

      const cards = Array.from(document.querySelectorAll("section[data-qid]"));
      let score = 0,
        total = cards.length;

      function updateScore() {
        document.getElementById("score").textContent = score + " / " + total;
      }

      cards.forEach((card) => {
        const q = JSON.parse(
          card.querySelector("script[data-qdata]").textContent
        );
        const exp = card.querySelector("[data-exp]");
        const btnCheck = card.querySelector(".btnCheck");
        const btnReset = card.querySelector(".btnReset");

        let validated = false; // pour ne pas compter 2x au score

        btnCheck.addEventListener("click", () => {
          // reset styles basiques
          exp.classList.add("hidden");
          exp.textContent = "";

          let ok = false;

          if (q.mode === "input") {
            const input = card.querySelector(".ansInput");
            const val = norm(input.value);
            const good = norm(q.answer);
            const accepted = (q.accepted || []).map(norm);
            ok = val === good || accepted.includes(val);

            input.classList.remove(
              "ring-2",
              "ring-red-300",
              "ring-green-300",
              "bg-red-50",
              "bg-green-50"
            );
            input.classList.add(
              ok ? "ring-green-300" : "ring-red-300",
              ok ? "bg-green-50" : "bg-red-50",
              "ring-2"
            );
          } else {
            const picked = card.querySelector("input.ansChoice:checked");
            const labels = Array.from(card.querySelectorAll("label"));
            labels.forEach((l) =>
              l.classList.remove(
                "ring-2",
                "ring-red-300",
                "ring-green-300",
                "bg-red-50",
                "bg-green-50"
              )
            );

            if (!picked) {
              exp.textContent = "Choisis une réponse.";
              exp.classList.remove("hidden");
              return;
            }
            const idx = parseInt(picked.value, 10);
            ok = idx === q.answerIndex;

            if (ok) {
              picked
                .closest("label")
                .classList.add("ring-2", "ring-green-300", "bg-green-50");
            } else {
              picked
                .closest("label")
                .classList.add("ring-2", "ring-red-300", "bg-red-50");
              const good = card
                .querySelector('input.ansChoice[value="' + q.answerIndex + '"]')
                .closest("label");
              good.classList.add("ring-2", "ring-green-300", "bg-green-50");
            }
          }

          // Explication / indice
          exp.textContent =
            (ok ? "✅ Correct !" : "❌ Incorrect.") +
            (q.tip ? " — Indice : " + q.tip : "");
          exp.classList.remove("hidden");
          exp.classList.toggle("text-green-700", ok);
          exp.classList.toggle("text-red-700", !ok);

          if (ok && !validated) {
            validated = true;
            score++;
            updateScore();
          }
        });

        btnReset.addEventListener("click", () => {
          // Réinitialiser la carte uniquement
          exp.classList.add("hidden");
          exp.textContent = "";
          validated = false;
          if (q.mode === "input") {
            const input = card.querySelector(".ansInput");
            input.value = "";
            input.classList.remove(
              "ring-2",
              "ring-red-300",
              "ring-green-300",
              "bg-red-50",
              "bg-green-50"
            );
          } else {
            const picked = card.querySelector("input.ansChoice:checked");
            picked && (picked.checked = false);
            const labels = Array.from(card.querySelectorAll("label"));
            labels.forEach((l) =>
              l.classList.remove(
                "ring-2",
                "ring-red-300",
                "ring-green-300",
                "bg-red-50",
                "bg-green-50"
              )
            );
          }
        });
      });

      document.getElementById("btnResetAll").addEventListener("click", () => {
        // Reset global (visuel + score)
        cards.forEach((card) => {
          card.querySelector(".btnReset").click();
        });
        score = 0;
        updateScore();
        window.scrollTo({ top: 0, behavior: "smooth" });
      });

      updateScore();
    </script>
    <%- include('partials/footer') %>
  </body>
</html>
